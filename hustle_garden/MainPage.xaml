<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:HuertoApp.ViewModels"
             xmlns:converters="clr-namespace:HuertoApp.Converters"
             x:Class="hustle_garden.MainPage"
             Title="?? Mis Plantas">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter"/>
            <converters:IsNotNullConverter x:Key="IsNotNullConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*, Auto">
        
        <!-- Fondo con gradiente -->
        <BoxView Grid.RowSpan="2">
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#E8F5E9" Offset="0.0"/>
                    <GradientStop Color="#F1F8E9" Offset="1.0"/>
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>

        <!-- Lista de plantas -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="15">
                
                <Label Text="?? Tus Plantas" 
                       FontSize="28" 
                       FontAttributes="Bold" 
                       TextColor="#1B5E20"
                       Margin="0,10,0,15"/>
                
                <CollectionView ItemsSource="{Binding Plantas}"
                                EmptyView="?? No hay plantas aún. ¡Toca el botón + para comenzar!">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <SwipeView Margin="0,0,0,12">
                                <SwipeView.RightItems>
                                    <SwipeItems>
                                        <SwipeItem Text="??? Borrar" 
                                                   BackgroundColor="#E53935"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HuertoViewModel}}, Path=BorrarPlantaCommand}"
                                                   CommandParameter="{Binding .}"/>
                                    </SwipeItems>
                                </SwipeView.RightItems>

                                <Border StrokeShape="RoundRectangle 20" 
                                        StrokeThickness="0"
                                        BackgroundColor="White">
                                    <Border.Shadow>
                                        <Shadow Brush="Black" Offset="0,4" Radius="16" Opacity="0.1"/>
                                    </Border.Shadow>
                                    
                                    <Grid ColumnDefinitions="140, *" 
                                          RowDefinitions="Auto"
                                          MinimumHeightRequest="140">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HuertoViewModel}}, Path=VerDetallePlantaCommand}"
                                                                  CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>

                                        <!-- Imagen con gradiente overlay -->
                                        <Border Grid.Column="0" 
                                                StrokeShape="RoundRectangle 20,0,0,20"
                                                StrokeThickness="0">
                                            <Grid>
                                                <Image Source="{Binding FotoPath}" 
                                                       Aspect="AspectFill"/>
                                                <BoxView Opacity="0.3">
                                                    <BoxView.Background>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                            <GradientStop Color="Transparent" Offset="0.0"/>
                                                            <GradientStop Color="#1B5E20" Offset="1.0"/>
                                                        </LinearGradientBrush>
                                                    </BoxView.Background>
                                                </BoxView>
                                            </Grid>
                                        </Border>

                                        <!-- Contenido -->
                                        <VerticalStackLayout Grid.Column="1" 
                                                             Padding="18,15" 
                                                             Spacing="8"
                                                             VerticalOptions="Center">
                                            <Label Text="{Binding Nombre}" 
                                                   FontSize="22" 
                                                   FontAttributes="Bold" 
                                                   TextColor="#1B5E20"
                                                   LineBreakMode="TailTruncation"/>
                                            
                                            <Label Text="{Binding Variedad, StringFormat='?? {0}'}" 
                                                   FontSize="15" 
                                                   TextColor="#4CAF50"
                                                   FontAttributes="Bold"
                                                   IsVisible="{Binding Variedad, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>
                                            
                                            <Border StrokeShape="RoundRectangle 10" 
                                                    Padding="12,6" 
                                                    BackgroundColor="#E8F5E9"
                                                    StrokeThickness="0"
                                                    HorizontalOptions="Start">
                                                <Label Text="{Binding Estado}" 
                                                       FontSize="13" 
                                                       TextColor="#2E7D32"
                                                       FontAttributes="Bold"/>
                                            </Border>
                                            
                                            <Label Text="{Binding FechaSiembra, StringFormat='?? Sembrada: {0:dd/MM/yyyy}'}" 
                                                   FontSize="13" 
                                                   TextColor="#666"
                                                   Margin="0,4,0,0"/>
                                            
                                            <Label Text="{Binding Ubicacion, StringFormat='?? {0}'}" 
                                                   FontSize="13" 
                                                   TextColor="#666"
                                                   IsVisible="{Binding Ubicacion, Converter={StaticResource StringNotNullOrEmptyConverter}}"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Espaciado inferior para el botón flotante -->
                <BoxView HeightRequest="80" Color="Transparent"/>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Botón flotante para agregar planta -->
        <Border Grid.Row="0"
                StrokeShape="RoundRectangle 35"
                StrokeThickness="0"
                WidthRequest="70"
                HeightRequest="70"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="30">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#4CAF50" Offset="0.0"/>
                    <GradientStop Color="#66BB6A" Offset="0.5"/>
                    <GradientStop Color="#81C784" Offset="1.0"/>
                </LinearGradientBrush>
            </Border.Background>
            <Border.Shadow>
                <Shadow Brush="#4CAF50" Offset="0,8" Radius="20" Opacity="0.5"/>
            </Border.Shadow>
            <Border.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding MostrarPopupAgregarPlantaCommand}"/>
            </Border.GestureRecognizers>
            
            <Label Text="+"
                   FontSize="40"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   Margin="0,-5,0,0"/>
        </Border>
    </Grid>
</ContentPage>
