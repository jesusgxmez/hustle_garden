<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:HuertoApp.ViewModels"
             xmlns:models="clr-namespace:HuertoApp.Models"
             x:Class="hustle_garden.Views.NotasPage"
             Title="Notas del Huerto">

    <Grid>
        <BoxView>
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#E8F5E9" Offset="0.0"/>
                    <GradientStop Color="#F1F8E9" Offset="1.0"/>
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>

        <Grid ColumnDefinitions="*,*" Padding="15" ColumnSpacing="15">
            <!-- COLUMNA IZQUIERDA: Formulario Nueva Nota -->
            <Border Grid.Column="0" StrokeShape="RoundRectangle 20" StrokeThickness="0" BackgroundColor="White">
                <Border.Shadow>
                    <Shadow Brush="Black" Offset="0,6" Radius="16" Opacity="0.12"/>
                </Border.Shadow>
                
                <Grid RowDefinitions="Auto, *">
                    <Border Grid.Row="0" BackgroundColor="#E1BEE7" Padding="20,15">
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="ðŸ“" FontSize="24" VerticalOptions="Center"/>
                            <Label Text="Nueva Nota" 
                                   FontAttributes="Bold" 
                                   FontSize="20" 
                                   TextColor="#6A1B9A"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </Border>
                    
                    <ScrollView Grid.Row="1">
                        <VerticalStackLayout Spacing="15" Padding="20" Margin="0,10">
                            <Border StrokeShape="RoundRectangle 12" 
                                    Stroke="#C8E6C9" 
                                    StrokeThickness="2"
                                    BackgroundColor="White">
                                <Entry Placeholder="Titulo de la nota" 
                                       Text="{Binding TituloNuevaNota}"
                                       PlaceholderColor="#66BB6A"
                                       TextColor="#1B5E20"
                                       FontSize="16"
                                       Margin="10,8"/>
                            </Border>

                            <Border StrokeShape="RoundRectangle 12" 
                                    Stroke="#C8E6C9" 
                                    StrokeThickness="2"
                                    BackgroundColor="White">
                                <Editor Placeholder="Escribe aqui el contenido de tu nota..." 
                                        Text="{Binding ContenidoNuevaNota}" 
                                        HeightRequest="150"
                                        PlaceholderColor="#66BB6A"
                                        TextColor="#1B5E20"
                                        Margin="10,8"/>
                            </Border>

                            <Border StrokeShape="RoundRectangle 12" 
                                    Stroke="#C8E6C9" 
                                    StrokeThickness="2"
                                    BackgroundColor="White">
                                <Picker Title="Categoria" 
                                        SelectedItem="{Binding CategoriaNuevaNota}"
                                        TextColor="#1B5E20"
                                        TitleColor="#66BB6A"
                                        Margin="5,0">
                                    <Picker.ItemsSource>
                                        <x:Array Type="{x:Type models:CategoriaNota}">
                                            <models:CategoriaNota>General</models:CategoriaNota>
                                            <models:CategoriaNota>Clima</models:CategoriaNota>
                                            <models:CategoriaNota>Plagas</models:CategoriaNota>
                                            <models:CategoriaNota>Fertilizacion</models:CategoriaNota>
                                            <models:CategoriaNota>Observacion</models:CategoriaNota>
                                            <models:CategoriaNota>Recordatorio</models:CategoriaNota>
                                        </x:Array>
                                    </Picker.ItemsSource>
                                </Picker>
                            </Border>

                            <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="12">
                                <Border Grid.Column="0" 
                                        StrokeShape="RoundRectangle 12"
                                        BackgroundColor="#4CAF50"
                                        StrokeThickness="0">
                                    <Border.Shadow>
                                        <Shadow Brush="#4CAF50" Offset="0,4" Radius="8" Opacity="0.3"/>
                                    </Border.Shadow>
                                    <Button Text="FOTO" 
                                            Command="{Binding TomarFotoCommand}"
                                            BackgroundColor="Transparent"
                                            TextColor="White"
                                            FontAttributes="Bold">
                                        <Button.ImageSource>
                                            <FontImageSource 
                                                Glyph="ðŸ“¸" 
                                                FontFamily="Arial"
                                                Size="18"
                                                Color="White"/>
                                        </Button.ImageSource>
                                    </Button>
                                </Border>
                                
                                <Border Grid.Column="1" 
                                        StrokeShape="RoundRectangle 12"
                                        BackgroundColor="#66BB6A"
                                        StrokeThickness="0">
                                    <Border.Shadow>
                                        <Shadow Brush="#66BB6A" Offset="0,4" Radius="8" Opacity="0.3"/>
                                    </Border.Shadow>
                                    <Button Text="GALERIA" 
                                            Command="{Binding SeleccionarGaleriaCommand}"
                                            BackgroundColor="Transparent"
                                            TextColor="White"
                                            FontAttributes="Bold">
                                        <Button.ImageSource>
                                            <FontImageSource 
                                                Glyph="ðŸ–¼ï¸" 
                                                FontFamily="Arial"
                                                Size="18"
                                                Color="White"/>
                                        </Button.ImageSource>
                                    </Button>
                                </Border>

                                <Border Grid.Column="2" 
                                        StrokeShape="RoundRectangle 10" 
                                        Stroke="#4CAF50"
                                        StrokeThickness="3"
                                        HeightRequest="50" 
                                        WidthRequest="50"
                                        BackgroundColor="White">
                                    <Image Source="{Binding FotoTemporal}" Aspect="AspectFill" />
                                </Border>
                            </Grid>

                            <Border StrokeShape="RoundRectangle 18" 
                                    StrokeThickness="0">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#6A1B9A" Offset="0.0"/>
                                        <GradientStop Color="#8E24AA" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.Shadow>
                                    <Shadow Brush="#6A1B9A" Offset="0,6" Radius="12" Opacity="0.3"/>
                                </Border.Shadow>
                                <Button Text="GUARDAR NOTA" 
                                        Command="{Binding AgregarNotaCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        FontSize="17"
                                        Padding="0,12">
                                    <Button.ImageSource>
                                        <FontImageSource 
                                            Glyph="ðŸ’¾" 
                                            FontFamily="Arial"
                                            Size="18"
                                            Color="White"/>
                                    </Button.ImageSource>
                                </Button>
                            </Border>
                        </VerticalStackLayout>
                    </ScrollView>
                </Grid>
            </Border>

            <!-- COLUMNA DERECHA: Notas Creadas -->
            <Border Grid.Column="1" StrokeShape="RoundRectangle 20" StrokeThickness="0" BackgroundColor="White">
                <Border.Shadow>
                    <Shadow Brush="Black" Offset="0,6" Radius="16" Opacity="0.12"/>
                </Border.Shadow>
                
                <Grid RowDefinitions="Auto, *">
                    <Border Grid.Row="0" BackgroundColor="#E8F5E9" Padding="20,15">
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="ðŸ“š" FontSize="24" VerticalOptions="Center"/>
                            <Label Text="Mis Notas" 
                                   FontSize="20" 
                                   FontAttributes="Bold" 
                                   TextColor="#2E7D32"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </Border>
                    
                    <ScrollView Grid.Row="1">
                        <CollectionView ItemsSource="{Binding Notas}"
                                        Margin="15"
                                        EmptyView="ðŸ“ No hay notas aÃºn. Â¡Empieza a escribir!">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView Margin="0,6">
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="ELIMINAR" 
                                                           BackgroundColor="#E53935"
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:NotasViewModel}}, Path=EliminarNotaCommand}"
                                                           CommandParameter="{Binding .}"/>
                                            </SwipeItems>
                                        </SwipeView.RightItems>

                                        <Border StrokeShape="RoundRectangle 20" 
                                                StrokeThickness="0"
                                                BackgroundColor="White"
                                                Stroke="#C8E6C9">
                                            <Border.Shadow>
                                                <Shadow Brush="Black" Offset="0,5" Radius="14" Opacity="0.1"/>
                                            </Border.Shadow>
                                            
                                            <VerticalStackLayout Padding="15" Spacing="10">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <HorizontalStackLayout Grid.Column="0" Spacing="8">
                                                        <Label Text="ðŸ“„" FontSize="20" VerticalOptions="Center"/>
                                                        <Label Text="{Binding Titulo}" 
                                                               FontSize="17" 
                                                               FontAttributes="Bold" 
                                                               TextColor="#1B5E20"
                                                               VerticalOptions="Center"
                                                               HorizontalOptions="FillAndExpand"/>
                                                    </HorizontalStackLayout>

                                                    <!-- BotÃ³n de eliminar simplificado -->
                                                    <Button Grid.Column="1"
                                                            Text="ðŸ—‘ï¸" 
                                                            FontSize="24"
                                                            BackgroundColor="Transparent"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:NotasViewModel}}, Path=EliminarNotaCommand}"
                                                            CommandParameter="{Binding .}"
                                                            WidthRequest="40"
                                                            HeightRequest="40"
                                                            Padding="0"
                                                            Margin="0"
                                                            HorizontalOptions="End"
                                                            VerticalOptions="Center"/>
                                                </Grid>

                                                <Border StrokeShape="RoundRectangle 10" 
                                                        Padding="10,5"
                                                        StrokeThickness="0"
                                                        HorizontalOptions="Start">
                                                    <Border.Background>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                            <GradientStop Color="{Binding Categoria, Converter={StaticResource CategoriaToPrimaryColorConverter}}" Offset="0.0"/>
                                                            <GradientStop Color="{Binding Categoria, Converter={StaticResource CategoriaToSecondaryColorConverter}}" Offset="1.0"/>
                                                        </LinearGradientBrush>
                                                    </Border.Background>
                                                    <HorizontalStackLayout Spacing="5">
                                                        <Label Text="{Binding Categoria, Converter={StaticResource CategoriaToEmojiConverter}}" FontSize="12"/>
                                                        <Label Text="{Binding Categoria}" 
                                                               FontSize="12" 
                                                               TextColor="White"
                                                               FontAttributes="Bold"/>
                                                    </HorizontalStackLayout>
                                                </Border>

                                                <Label Text="{Binding Contenido}" 
                                                       FontSize="14" 
                                                       TextColor="#424242"
                                                       MaxLines="3"
                                                       LineBreakMode="TailTruncation"/>

                                                <Border StrokeShape="RoundRectangle 12"
                                                        StrokeThickness="0"
                                                        IsVisible="{Binding FotoPath, Converter={StaticResource StringNotNullOrEmptyConverter}}">
                                                    <Image Source="{Binding FotoPath}" 
                                                           Aspect="AspectFill" 
                                                           HeightRequest="150"/>
                                                </Border>

                                                <HorizontalStackLayout Spacing="6" Margin="0,3,0,0">
                                                    <Label Text="ðŸ“…" FontSize="14"/>
                                                    <Label Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy HH:mm}'}" 
                                                           FontSize="12" 
                                                           TextColor="#757575"
                                                           VerticalOptions="Center"/>
                                                </HorizontalStackLayout>
                                            </VerticalStackLayout>
                                        </Border>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
