<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:HuertoApp.Converters"
             x:Class="hustle_garden.Views.DetallePlantaPage"
             Title="Detalle de Planta">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IsNotNullConverter x:Key="IsNotNullConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <BoxView>
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#C8E6C9" Offset="0.0"/>
                    <GradientStop Color="#DCEDC8" Offset="1.0"/>
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>
        
        <ScrollView>
            <VerticalStackLayout Spacing="20" Padding="20">

                <!-- Card principal de la planta -->
                <Border StrokeShape="RoundRectangle 25" 
                        StrokeThickness="0"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,8" Radius="20" Opacity="0.15"/>
                    </Border.Shadow>
                    
                    <Grid RowDefinitions="280, Auto">
                        <!-- Imagen con overlay -->
                        <Border Grid.Row="0" 
                                StrokeShape="RoundRectangle 25,25,0,0"
                                StrokeThickness="0">
                            <Grid>
                                <Image Source="{Binding Planta.FotoPath}" 
                                       Aspect="AspectFill"/>
                                <BoxView Opacity="0.3">
                                    <BoxView.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                            <GradientStop Color="Transparent" Offset="0.0"/>
                                            <GradientStop Color="#1B5E20" Offset="1.0"/>
                                        </LinearGradientBrush>
                                    </BoxView.Background>
                                </BoxView>
                                
                                <!-- BotÃ³n de cerrar flotante -->
                                <Border StrokeShape="RoundRectangle 20" 
                                        Padding="0"
                                        Margin="20"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"
                                        WidthRequest="45"
                                        HeightRequest="45"
                                        StrokeThickness="0"
                                        BackgroundColor="White">
                                    <Border.Shadow>
                                        <Shadow Brush="Black" Offset="0,4" Radius="12" Opacity="0.3"/>
                                    </Border.Shadow>
                                    <Button Text="âœ•" 
                                            FontSize="24" 
                                            TextColor="#E53935"
                                            BackgroundColor="Transparent"
                                            Clicked="OnCerrarClicked"
                                            Padding="0"
                                            FontAttributes="Bold"/>
                                </Border>
                            </Grid>
                        </Border>

                        <!-- InformaciÃ³n de la planta -->
                        <VerticalStackLayout Grid.Row="1" Padding="25" Spacing="12">
                            <Label Text="{Binding Planta.Nombre}" 
                                   FontSize="32" 
                                   FontAttributes="Bold" 
                                   TextColor="#1B5E20"/>
                            
                            <HorizontalStackLayout Spacing="10">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="ðŸŒ¿" FontSize="18"/>
                                    <Label Text="{Binding Planta.Variedad}" 
                                           FontSize="18" 
                                           TextColor="#4CAF50"
                                           FontAttributes="Bold"/>
                                </HorizontalStackLayout>
                                
                                <!-- Badge de estado al lado de la variedad -->
                                <Border StrokeShape="RoundRectangle 15" 
                                        Padding="12,6"
                                        StrokeThickness="0">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                            <GradientStop Color="#4CAF50" Offset="0.0"/>
                                            <GradientStop Color="#66BB6A" Offset="1.0"/>
                                        </LinearGradientBrush>
                                    </Border.Background>
                                    <Border.Shadow>
                                        <Shadow Brush="#4CAF50" Offset="0,3" Radius="8" Opacity="0.3"/>
                                    </Border.Shadow>
                                    <Label Text="{Binding Planta.Estado}" 
                                           FontSize="13" 
                                           TextColor="White"
                                           FontAttributes="Bold"/>
                                </Border>
                            </HorizontalStackLayout>
                            
                            <BoxView HeightRequest="1" Color="#E0E0E0" Margin="0,8"/>
                            
                            <Grid ColumnDefinitions="*, *" RowDefinitions="Auto, Auto" ColumnSpacing="15" RowSpacing="12">
                                <Border Grid.Row="0" Grid.Column="0" 
                                        StrokeShape="RoundRectangle 12"
                                        Padding="15,12"
                                        BackgroundColor="#E8F5E9"
                                        StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="UBICACION" 
                                               FontSize="12" 
                                               TextColor="#666"/>
                                        <HorizontalStackLayout Spacing="4">
                                            <Label Text="ðŸ“" FontSize="14"/>
                                            <Label Text="{Binding Planta.Ubicacion}" 
                                                   FontSize="15" 
                                                   TextColor="#2E7D32"
                                                   FontAttributes="Bold"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Border>
                                
                                <Border Grid.Row="0" Grid.Column="1" 
                                        StrokeShape="RoundRectangle 12"
                                        Padding="15,12"
                                        BackgroundColor="#FFF3E0"
                                        StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="ðŸ“… DÃ­as sembrada" 
                                               FontSize="12" 
                                               TextColor="#666"/>
                                        <Label Text="{Binding Planta.DiasDesdeSelecciÃ³n}" 
                                               FontSize="15" 
                                               TextColor="#F57C00"
                                               FontAttributes="Bold"/>
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                            
                            <Border StrokeShape="RoundRectangle 18" 
                                    StrokeThickness="0"
                                    Margin="0,15,0,0">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#2E7D32" Offset="0.0"/>
                                        <GradientStop Color="#4CAF50" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.Shadow>
                                    <Shadow Brush="#2E7D32" Offset="0,6" Radius="12" Opacity="0.3"/>
                                </Border.Shadow>
                                <Button Text="CAMBIAR ESTADO" 
                                        Command="{Binding CambiarEstadoCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Padding="0,14">
                                    <Button.ImageSource>
                                        <FontImageSource 
                                            Glyph="ðŸ”„" 
                                            FontFamily="Arial"
                                            Size="18"
                                            Color="White"/>
                                    </Button.ImageSource>
                                </Button>
                            </Border>
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <!-- SecciÃ³n de Riego -->
                <Border StrokeShape="RoundRectangle 20" 
                        StrokeThickness="0"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,6" Radius="16" Opacity="0.12"/>
                    </Border.Shadow>
                    
                    <VerticalStackLayout Padding="20" Spacing="15">
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="ðŸ’§" FontSize="28" VerticalOptions="Center"/>
                            <Label Text="Registrar Riego" 
                                   FontSize="22" 
                                   FontAttributes="Bold" 
                                   TextColor="#0277BD"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                        <Border StrokeShape="RoundRectangle 15" 
                                Stroke="#B3E5FC" 
                                StrokeThickness="2"
                                BackgroundColor="#E1F5FE"
                                Padding="5">
                            <HorizontalStackLayout Spacing="10">
                                <Border StrokeShape="RoundRectangle 12" 
                                        BackgroundColor="White"
                                        StrokeThickness="0"
                                        HorizontalOptions="FillAndExpand"
                                        Padding="5">
                                    <Entry Placeholder="Litros de agua" 
                                           Text="{Binding CantidadRiegoNuevo}" 
                                           Keyboard="Numeric"
                                           HorizontalOptions="FillAndExpand"
                                           PlaceholderColor="#0288D1"
                                           TextColor="#01579B"
                                           FontSize="16"
                                           FontAttributes="Bold"/>
                                </Border>
                                
                                <Border StrokeShape="RoundRectangle 15" 
                                        StrokeThickness="0"
                                        Padding="20,0">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                            <GradientStop Color="#0288D1" Offset="0.0"/>
                                            <GradientStop Color="#03A9F4" Offset="1.0"/>
                                        </LinearGradientBrush>
                                    </Border.Background>
                                    <Border.Shadow>
                                        <Shadow Brush="#0288D1" Offset="0,4" Radius="8" Opacity="0.3"/>
                                    </Border.Shadow>
                                    <Button Text="Registrar" 
                                            Command="{Binding RegistrarRiegoCommand}"
                                            BackgroundColor="Transparent"
                                            TextColor="White"
                                            FontAttributes="Bold"/>
                                </Border>
                            </HorizontalStackLayout>
                        </Border>

                        <Label Text="ðŸ“‹ Ãšltimos riegos" 
                               FontAttributes="Bold" 
                               FontSize="16"
                               TextColor="#0277BD"
                               Margin="0,10,0,5"/>
                        
                        <CollectionView ItemsSource="{Binding Riegos}">
                            <CollectionView.EmptyView>
                                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20" Spacing="10">
                                    <Label Text="ðŸ’§" FontSize="48" HorizontalOptions="Center"/>
                                    <Label Text="Sin riegos registrados aÃºn" TextColor="#1B5E20" FontSize="18" FontAttributes="Bold" HorizontalOptions="Center"/>
                                    <Label Text="Â¡Registra el primer riego!" TextColor="#424242" FontSize="14" HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border StrokeShape="RoundRectangle 12" 
                                            Margin="0,4"
                                            Padding="15,10"
                                            BackgroundColor="#E1F5FE"
                                            StrokeThickness="0">
                                        <HorizontalStackLayout Spacing="15">
                                            <Label Text="ðŸ’§" FontSize="20" VerticalOptions="Center"/>
                                            <Label Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy HH:mm}'}" 
                                                   TextColor="#0277BD" 
                                                   FontSize="14"
                                                   WidthRequest="130"
                                                   VerticalOptions="Center"/>
                                            <Border StrokeShape="RoundRectangle 10"
                                                    Padding="10,5"
                                                    BackgroundColor="#0288D1"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                <Label Text="{Binding CantidadLitros, StringFormat='{0:F1} L'}" 
                                                       TextColor="Black" 
                                                       FontAttributes="Bold"
                                                       FontSize="14"/>
                                            </Border>
                                        </HorizontalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- SecciÃ³n de Cosecha -->
                <Border StrokeShape="RoundRectangle 20" 
                        StrokeThickness="0"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,6" Radius="16" Opacity="0.12"/>
                    </Border.Shadow>
                    
                    <VerticalStackLayout Padding="20" Spacing="15">
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="ðŸŒ½" FontSize="28" VerticalOptions="Center"/>
                            <Label Text="Registrar Cosecha" 
                                   FontSize="22" 
                                   FontAttributes="Bold" 
                                   TextColor="#E65100"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                        <Border StrokeShape="RoundRectangle 12" 
                                Stroke="#FFE0B2" 
                                StrokeThickness="2"
                                BackgroundColor="White">
                    <Entry Placeholder="Cantidad en kg" 
                           Text="{Binding CantidadCosechaNueva}" 
                           Keyboard="Numeric"
                           PlaceholderColor="#F57C00"
                           TextColor="#E65100"
                           FontSize="16"
                           FontAttributes="Bold"
                           Margin="10,8"/>
                        </Border>

                        <Border StrokeShape="RoundRectangle 12" 
                                Stroke="#FFE0B2" 
                                StrokeThickness="2"
                                BackgroundColor="White">
                            <Picker Title="â­ Selecciona la calidad" 
                                    SelectedIndex="{Binding SelectedIndexCalidad}"
                                    TextColor="#E65100"
                                    TitleColor="#F57C00"
                                    FontSize="16"
                                    Margin="5,0">
                                <Picker.ItemsSource>
                                    <x:Array Type="{x:Type x:String}">
                                        <x:String>Excelente</x:String>
                                        <x:String>Buena</x:String>
                                        <x:String>Regular</x:String>
                                        <x:String>Pobre</x:String>
                                    </x:Array>
                                </Picker.ItemsSource>
                            </Picker>
                        </Border>

                        <Border StrokeShape="RoundRectangle 12" 
                                Stroke="#FFE0B2" 
                                StrokeThickness="2"
                                BackgroundColor="White">
                    <Editor Placeholder="Notas adicionales (opcional)" 
                            Text="{Binding NotasCosechaNueva}" 
                            HeightRequest="80"
                            PlaceholderColor="#F57C00"
                            TextColor="#E65100"
                            Margin="10,8"/>
                        </Border>

                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                            <Border Grid.Column="0"
                                    StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="0">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#66BB6A" Offset="0.0"/>
                                        <GradientStop Color="#81C784" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.Shadow>
                                    <Shadow Brush="#66BB6A" Offset="0,3" Radius="6" Opacity="0.3"/>
                                </Border.Shadow>
                                <Button Text="ðŸ“¸ CÃ¡mara" 
                                        Command="{Binding TomarFotoCosechaCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        FontSize="13"
                                        Padding="8,10"/>
                            </Border>
                            
                            <Border Grid.Column="1"
                                    StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="0">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#42A5F5" Offset="0.0"/>
                                        <GradientStop Color="#64B5F6" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.Shadow>
                                    <Shadow Brush="#42A5F5" Offset="0,3" Radius="6" Opacity="0.3"/>
                                </Border.Shadow>
                                <Button Text="ðŸ–¼ï¸ GalerÃ­a" 
                                        Command="{Binding SeleccionarFotoCosechaGaleriaCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        FontSize="13"
                                        Padding="8,10"/>
                            </Border>
                            
                            <Border Grid.Column="2"
                                    StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="0">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#AB47BC" Offset="0.0"/>
                                        <GradientStop Color="#BA68C8" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.Shadow>
                                    <Shadow Brush="#AB47BC" Offset="0,3" Radius="6" Opacity="0.3"/>
                                </Border.Shadow>
                                <Button Text="ðŸ“ Archivo" 
                                        Command="{Binding SeleccionarFotoCosechaArchivoCommand}"
                                        BackgroundColor="Transparent"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        FontSize="13"
                                        Padding="8,10"/>
                            </Border>
                        </Grid>

                        <Border StrokeShape="RoundRectangle 18" 
                                StrokeThickness="0"
                                Margin="0,5,0,0">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#F57C00" Offset="0.0"/>
                                    <GradientStop Color="#FF9800" Offset="1.0"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <Border.Shadow>
                                <Shadow Brush="#F57C00" Offset="0,6" Radius="12" Opacity="0.4"/>
                            </Border.Shadow>
                    <Button Text="REGISTRAR COSECHA" 
                            Command="{Binding RegistrarCosechaCommand}"
                            BackgroundColor="Transparent"
                            TextColor="White"
                            FontAttributes="Bold"
                            FontSize="17"
                            Padding="0,14">
                        <Button.ImageSource>
                            <FontImageSource 
                                Glyph="âœ¨" 
                                FontFamily="Arial"
                                Size="18"
                                Color="White"/>
                        </Button.ImageSource>
                    </Button>
                        </Border>
                    </VerticalStackLayout>
                </Border>

                <!-- Historial de Cosechas -->
                <Border StrokeShape="RoundRectangle 20" 
                        StrokeThickness="0"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,6" Radius="16" Opacity="0.12"/>
                    </Border.Shadow>
                    
                    <VerticalStackLayout Padding="20" Spacing="15">
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="ðŸ“Š" FontSize="28" VerticalOptions="Center"/>
                            <Label Text="Historial de Cosechas" 
                                   FontSize="22" 
                                   FontAttributes="Bold" 
                                   TextColor="#6A1B9A"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                        <CollectionView ItemsSource="{Binding Cosechas}">
                            <CollectionView.EmptyView>
                                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20" Spacing="10">
                                    <Label Text="ðŸŒ¾" FontSize="48" HorizontalOptions="Center"/>
                                    <Label Text="Sin cosechas registradas aÃºn" TextColor="#1B5E20" FontSize="18" FontAttributes="Bold" HorizontalOptions="Center"/>
                                    <Label Text="Â¡Registra tu primera cosecha!" TextColor="#424242" FontSize="14" HorizontalOptions="Center"/>
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border StrokeShape="RoundRectangle 15" 
                                            Margin="0,6"
                                            StrokeThickness="0"
                                            Padding="18">
                                        <Border.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                <GradientStop Color="#FFF9C4" Offset="0.0"/>
                                                <GradientStop Color="#FFF59D" Offset="1.0"/>
                                            </LinearGradientBrush>
                                        </Border.Background>
                                        <Border.Shadow>
                                            <Shadow Brush="#FBC02D" Offset="0,3" Radius="8" Opacity="0.2"/>
                                        </Border.Shadow>
                                        
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="15">
                                            <!-- Imagen de la cosecha -->
                                            <Border Grid.Column="0"
                                                    StrokeShape="RoundRectangle 12"
                                                    StrokeThickness="0"
                                                    WidthRequest="100"
                                                    HeightRequest="100"
                                                    BackgroundColor="#FFF3E0"
                                                    IsVisible="{Binding FotoPath, Converter={StaticResource IsNotNullConverter}}">
                                                <Image Source="{Binding FotoPath}" 
                                                       Aspect="AspectFill"/>
                                            </Border>
                                            
                                            <!-- Placeholder si no hay imagen -->
                                            <Border Grid.Column="0"
                                                    StrokeShape="RoundRectangle 12"
                                                    StrokeThickness="2"
                                                    Stroke="#FFE0B2"
                                                    WidthRequest="100"
                                                    HeightRequest="100"
                                                    BackgroundColor="#FFF8E1"
                                                    IsVisible="{Binding FotoPath, Converter={StaticResource IsNotNullConverter}, ConverterParameter=Invert}">
                                                <Label Text="ðŸŒ¾" 
                                                       FontSize="40"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"
                                                       Opacity="0.4"/>
                                            </Border>
                                            
                                            <!-- InformaciÃ³n de la cosecha -->
                                            <VerticalStackLayout Grid.Column="1" Spacing="8">
                                                <HorizontalStackLayout Spacing="10">
                                                    <Label Text="ðŸ“…" FontSize="18"/>
                                                    <Label Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy}'}" 
                                                           FontAttributes="Bold"
                                                           FontSize="16"
                                                           TextColor="#F57F17"/>
                                                </HorizontalStackLayout>
                                                
                                                <HorizontalStackLayout Spacing="10">
                                                    <Label Text="âš–ï¸" FontSize="18"/>
                                                    <Label Text="{Binding CantidadKg, StringFormat='{0:F2} kg'}" 
                                                           TextColor="#FF6F00"
                                                           FontSize="18"
                                                           FontAttributes="Bold"/>
                                                </HorizontalStackLayout>
                                                
                                                <HorizontalStackLayout Spacing="10">
                                                    <Label Text="â­" FontSize="18"/>
                                                    <Label Text="{Binding Calidad}" 
                                                           TextColor="#E65100"
                                                           FontSize="15"
                                                           FontAttributes="Bold"/>
                                                </HorizontalStackLayout>
                                                


                                                <Label Text="{Binding Notas}" 
                                                       TextColor="#6D4C41"
                                                       FontSize="14"
                                                       Margin="0,4,0,0"
                                                       LineBreakMode="WordWrap"
                                                       MaxLines="3"/>
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
